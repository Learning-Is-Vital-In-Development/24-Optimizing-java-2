# Ch7. 가비지 수집 고급

## 동시 GC 이론

### JVM 세이브포인트
- 어플리케이션은 스레드마다 세이프포인트라는 특별한 실행 지점을 둔다.
- 세이브포인트는 스레드의 내부 자료 구조가 훤히보이는 지점으로, 이 지점에서 어떤 작업을 하기 위해 스레드는 잠시 중단될 수 있다.
- JVM 세이브 포인트 처리 규칙
  - JVM은 강제로 스레드를 세이브포인트 상태로 바꿀 수 없다.
  - JVM은 스레드가 세이브포인트 상태에서 벗어나지 못하게 할 수 없다.

### 삼색 마킹
- GC 루트를 흰색 표시
- 다른 객체는 모두 흰색 표시
- 마킹 스레드가 회색 노드로 랜덤하게 이동
- 이동한 노드를 검은색 표시하고 이 노드가 가리키는 모든 흰색 노드를 회색 표시
- 회색 노드가 하나도 남지 않을 때까지 위 과정을 반복
- 검은색 객체는 모두 접근 가능한 것이므로 살아남느다.
- 흰색 노드는 더 이상 접근 불가능한객체이므로 수집 대상이 된다.

## CMS
CMS 수집기는 중단 시간을 아주 짧게 하려고 설계된, 테뉴어드 공간 전용 수집기이다.
- 수행 단계
  1. 초기 마킹 (STW)
  2. 동시 마킹
  3. 동시 사전 정리
  4. 재마킹 (STW)
  5. 동시 스위프
  6. 동시 리셋
  - 한 차례 긴 STW 중단을 일반적으로 매우 짧은 두 차례 STW 중단으로 대체

- CMS 특징
  - 어플리케이션 스레드가 오랫동안 멈추지 않는다.
  - 단일 풀 GC 사이클 시간이 더 길다.
  - CMS GC 사이클 실행 시간 동안 어플리케이션 처리율은 감소한다
  - GC가 객체를 추적해야 하므로 메모리를 더 많이 쓴다.
  - GC 수행에 훨씬 더 많은 CPU 시간이 소모된다.
  - CMS는 힘을 압착하지 않으므로 테뉴어드 영역을 단편화될 수 있다.

## G1
중단 시간이 짧은 새로운 수집기로 설계되었다.
- G1 특징
  - CMS보다 훨씬 튜닝하기 쉽다.
  - 조기 승격에 덜 취약
  - 대용량 힙에서 확장성(중단 시간)이 우수하다.
  - 풀 STW 수집을 없앨 수 있다.
- G1 힙은 리전(가상의 메모리 분할 공간)으로 구성된다.
- 리전을 이용할 경우 세대를 불연속적으로 배치할 수 있고, 수집기가 매번 실행될 때마다 전체 가비지 수집을 진행할 필요가 없다.
- G1 단계
  1. 초기 마킹(STW)
  2. 동시 루트 탐색
  3. 동시 마킹
  4. 재마킹(STW)
  5. 정리(STW)
