# 7. 가비지 수집 고급
- 현대 자바의 가비지 수집 이론
- 다양한 수집기들의 선정하는 배경
- 각종 수집기들의 특성


## 7.1 트레이드오프와 탈착형 수집기
- 코드 변경없이 탈착가능하다.
- 고려 항목들
  - 중단시간 (제일큰 관심사)
  - 처리율 (런타임 대비 GC 시간 %)
  - 중단 빈도 (수집기 때문에 얼마나 자주 멈추냐)
  - 회수 효율 (GC 사이클당 얼마나 많은 가비지 수집되는가?)
  - 중단 일관성(중단시간이 고르냐?)
- 예
  - 배치처리 시스템은 중단 기간보다 처리율이 더 큰 영향을 미친다.
  - CPU 효율 및 처리율 우수한 GC를 사용해야한다.
## 7.2 동시 GC 이론
- 문제: 메모리 할당이 불확정성을 유발하므로 언제 끼어들지 확정적이지 않다.
- 최신 GC는 해당 문제를 해결하려고 시도한다.
- 동시 수집기를 써서 스레드 실행 도중 수집에 필요한 작업 일부를 수행한다.
### 7.2.1 JVM 세이프 포인트
- STW 가비지 수집을 하려면 애플리케이션 스레드를 모두 중단시켜야합니다.
- JVM은 스레드마다 SAFE POINT를 둡니다.
- GC 스레드가 OS에게 무조건 중단시켜달라고 요청할 수 없기 때문에, 애플리케이션 스레드는 반드시 서로 공조해야합니다.
  - JVM은 강제로 스레드를 세이프포인트 상태로 바꿀 수 없다.
  - JVM은 스레드가 세이프 포인트 상태에서 벗어나지 못하게 할 수 있다.
- JVM이 중단 하는 방법
- 1. JVM이 전역 세이프포인트 시간 플래그를 세팅한다.
- 2. 각 애플리케이션 스레드는 폴링 하면서 이 플래그가 세팅됐는지 확인한다.
- 3. 애플리케이션 스레드는 일단 멈췄다가 다시 깨어날때까지 대기한다.
- 일반 애플리케이션 스레드는 이런 식으로 바이트 코드 2개 실행할때마다 체크하게 된다. 
### 7.2.2 삼색 마킹
- 알고리즘 동작원리
  - GC루트를 회색 표시한다.
  - 다른 객체는 모두 흰색 표시한다.
  - 마킹 스레드가 임의의 회색 노드로 이동한다.
  - 마킹 스레드가 흰색 표시된 자식 노드가 있는 노드를 만나면, 먼저 회색 표시한후 해당 노드를 검은색으로 표시한다.
  - 회색 노드가 하나도 남지 않을때까지 위 과정을 되풀이한다.
    - 검은색 객체는 접근 가능한것으로 살아남는다.
    - 흰색객체는 수집대상이된다.
- 동시 수집 (스냅샷뜨기)
  - 수집 사이클 시작할때, 할당된 객체는 라이브 객체로 간주한다.
- 단점
  - 변경자 스레드가 수집하는 도중에 검은색 상태, 수집을 안하는 동안 흰색 상태로 객체 생성
  - 라이브 객체가 수집되는 현상이 생길 수 도 있다.
  - 업데이트시에 쓰기 배리어를 이용해서 마킹 사이클 동안 삼색을 그대로 유지합니다.
    - `동시 마킹 도중에 검은색 객체 노드가 흰색 객체노드를 가리킬 수 없다.`
  - 모든 변경사항을 미리 큐에 넣어두고 MAIN 이 끝나면 FIXUP에 바로잡는 경우도 있습니다.

## 7.3 CMS
- CMS 수집기는 중단시간을 아주 짧게하려고 설계된 TENURED 공간 전용 수집기입니다.
- 중단 시간을 최소화 하기 위해 스레드 실행중에 가급적 많은 일을 합니다.
- 마킹은 삼색 마킹
- 레코드 FIXUP
  - 초기 마킹 (STW)  GC루트 얻음
  - 동시 마킹 | 삼색 마킹 진행
  - 동시 사전 정리
  - 재마킹 (STW)
  - 동시 스윕
  - 동시 리셋
- 효과
  - 애플리케이션이 오래 멈추지 않는다.
  - 단일 풀 GC 사이클 시간이 더길다.
  - CMS GC 사이클동안 처리율 감소한다.
  - GC가 객체를 추적하므로 메모리 사용 증가한다.
  - GC 수행에 훨씬 더 많은 CPU 시간이 필요하다.
  - CMS는 힙을 압착하지 않아서 테뉴어드 영역은 단편화된다.
  - 느린 GC로 조기승격이 많이일어나 TENURED 공간 부족이 생긴다
  - 동시 모드 실패로 불린다.
  - 75 % 점유 이상시에 CMS 가 수집을 하는게 옵션으로 잡혀있다.
  - 힙 단편화가 발생해서 그럴수도있다.
  - 스위퍼 스레드로 여유 공간을 뭄치는 역할을 한다.
## 7.4 G1
- CMS와 스타일이 다른 수집기입니다.
- 특징
  - CMS 보다 튜닝이 쉽다.
  - 조기 승격에 덜 취약하다.
  - 대용량 힙에서 확장성이 우수하다.
  - 풀 STW 수집을 없앨수 있다.
- G1 힙 레이아웃 및 영역
  - G1 힙은 영역으로 구성됩니다
  - 영역은 디폴트 크기가 1MB
  - 영역을 이용하면 세대를 연속적으로 배치할 필요 없습니다.
  - 수집기가 매번 전체 가비지 수집 할 필요 없다.
- G1 알고리즘 설계
  - 동시 마킹 단계를 이용한다.
  - 방출 수집기
  - 통계적으로 압착한다.
- TLAB 할당, 서바이버 공간 방출, 테뉴어드 승격 은 개념 같다.
- 차이점
  - 영 세대의 크기는 전체 중단 시간 목표에 따라 조정된다.
  - `올드 객체가 영객체를 참조하는일은 거의 없다.`
  - G1 에서는 RSET이라는 장치로 영역을 추적합니다.
  - RSET은 영역별로 하나씩 영역 내부를 참조하는 레퍼런스를 관리하기 위한 장치입니다.
  - 전체 힙을 다 뒤질 필요없이 RSET만 꺼내보면됩니다.
  - RSET은 부유 가비지 라는 GC 문제를 해결하는데 유용합니다.
  - 전역적으로 LIVE 이지만 사용한 루트 세트에 따라 범위가 제한적인 로컬 마킹상에서 살아있는 객체로 잘못 인식된다.
- G1 단계
  - 초기 마킹 (STW) 서바이버 영역에서 올드세대 레퍼런스 찾기 그다음 영 GC 탐색
  - 동시 루트 탐색
  - 동시 마킹
  - 재마킹(STW)
  - 정리(STW) 어카운팅, RSET의 씻기 

## 7.5 셰난도아
- 주목표는 중단시간 단축
- 동시 압착을한다.
- 단계
  - 초기마킹(STW)
  - 동시마킹
  - 최종마킹(STW)
  - 동시압착
- 브룩스 포인터라고 객체가 재배치 됐는지 표기하는 포인터가 생깁니다.
- 해당 포인터가 있으면 새 OOP 위치를 참조하도록 수정합니다.
- 동시 압착 메커니즘
  - 객체를 TLAB로 복사한다.
  - CAS로 브룩스 포인터가 추측성 사본을 가리키도록 수정한다.
  - 이 작업이 성공하면 압착스레드가 승리 이후 모든 버전은 브룩스 포인터를 경유한다.
  - 실패하면 압착스레드가 실패한것으로 추측성 사본을 원상복구하고 승리한 스레드가 남긴 브룩스 포인터를 따라간다.
- 해당 수집기는 레드햇 페도라 같은 배포판에 실려있다.
- 중단시간 개짧네;;
## 7.6 C4
- 오라클 상용 솔루션
- 동시 압착 알고리즘 사용하는데 객체 헤더를 쓴다.
- 로드값을 자가치유 베리어로 로딩이 끝나면 객체 위치를 직접 가리키게 만들자.
- 단계
  - 마킹
  - 재배치
  - 재매핑
- 영객체 + 올드 객체
- 동시 수집기 튜닝시 수집기가 백투백모드로 실행된다.
## 7.7 밸런스드
- 4GB 이상의 힙에 맞게 설계됨
- 대용량 힙에서 중단시간 길어지는 현상 개선
- 중단 시간이 최악일 경우 최소화
- IBM 에서 부분 가비지 수집으로 에덴이 꽉차면 수집진행함
- 나이가 많은 영역은 필요하면 수집하게됩니다. (G1 도 MIXED COLLECTION 함)
- 전역 가비지 수집도 있다.
- 객체 헤더는 클래스 슬롯이라고 불린다.
- 어레이릿이라고 여러 영역에 걸쳐서 할당할 수 있따.
  - 전체 GC 시간은 더걸리지만 평균 중단시간은 줄어든다. 
  - 압착 혹은 stw 수집의 경우의 수가 줄어든다.
  
## 7.8 레거시 핫스팟 수집기
- Serial && Serial Old
  - Parallel Old GC와 동작원리 동일
- 증분 CMS
  - 동시 수집
  - G1에 영향
- 엡실론
  - 아무일도 안하는 수집기
    - 테스트 및 벤치마킹
    - 회귀 테스트
    - 할당률이 0인 애플리케이션 혹은 라이브러리 코드의 테스트
    - JMH테스트 용
## 7.9 마치며
