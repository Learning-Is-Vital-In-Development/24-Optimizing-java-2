# 3장 - 하드웨어와 운영체제

> 오랬동안 컴퓨터업계는 무어의 법칙대로 흘러갔다.
그 결과, 소프트웨어는 강력한 파워를 자유자재로 구사할 정도로 발전했음에도, 성능 향상을 꾀하려면 복잡한 기반 기술에 의지 할 수 밖에 없게 되었다.
이번 장에서 최신 하드웨어와 OS에 관해 빠르게 훑어보자.
> 

---

##  최신 하드웨어 소개

아직도 많은 수업에서 CPU에 실제로 일어나는 일을 시키는 C프로그래밍이야 말로 진리의 원천인양 강조하는 편이지만 요즘은 이러한 생각은 맞지 않다.

1990년대 이후, 대부분 하드웨어는 인텔 x86/x64 아키텍처 위주로 돌아갔다. 

이제 프로세서 작동 원리를 단순화한 멘탈 모델(정신 모형)은 전혀 맞지 않고 그런 모델을 토대로 직관적인 추론을 하면 완전히 생뚱맞은 결론을 내리기 쉽습니다

---

##  메모리

요즘 자바 개발자에게 가장 중요한 메모리를 살펴보자.

무어의 법칙에 따라 급증한 트랜지스터는 클록 속도를 높이는데 쓰였다. 클록 속도의 증가로 초당 더 많은 명령어를 처리할 수 있게 되었지만 시간이 갈수록 프로세서 코어의 데이터 수요를 메모리가 따라가 어려워 졌다. 

*4.77MHz(최초의 IBM PC칩) → 2GHz* 

클록 속도가 올라가도 데이터가 도착할 때까지 CPU는 놀면서 기다려야 하니 아무 소용 없게 됐다.

- 메모리  캐시
    
    CPU 캐시는 CPU에 있는 메모리 영역이다. 레지스터보다는 느리지만 메인 메모리 보다 훨씬 빠르다.
    
    액세스 빈도가  높은 캐시일수록 프로세서  코어와 더 가까이 위치하는 식으로 여러 캐시 계층이 있다. 
    
    클록 속도와 액세스 시간 차이를 줄이기 위해 최신 CPU는 캐시에많은 예산을 투자한다.
    
    메모리에 있는 데이터를 어떻게 처리하고 어떻게 메모리에 다시 써야할지 결정하기위해 **캐시 일관성 프로토콜**이라는 방법을 사용한다.
    

---

##  최신 프로세서의 특성

메모리 캐시는 증가하는 트랜지스터를 확실하게 활용하는 주요 부분이지만, 수년간 여러 다른 기술도 등장했다.

- 변환 색인 버퍼 (TLB)
    
    가상 메모리 주소를 물리 메모리 주소로 매핑하는 페이지 테이블의 캐시 역할을 수행한다. 덕분에 가상 주소를 참조해 물리 주소에 액세스하는 빈번한 작업 속도가 매우 빨라진다.
    
- 분기 예측과 추측 실행
    
    분기 예측은 프로세서가 조건 분기하는 기준값을 평가하느라 대기하는 현상을 방지한다. 
    
    프로세스는 트랜지스터를 아낌없이 활용해 가장 발생 가능성이 큰 브랜치를 미리 결정하는 휴리스틱을 형성한다. 하지만 예측이 틀리면 부분적으로 실행한 명령을 모두 폐기한 후 파이프라인을 비우는 대가를 치룬다.
    
- 하드웨어 메모리 모델
    
    멀티코어 시스템에서 서로 다른 여러 CPU가 일관되게 동일한 메모리 주소를 액세스 할 수 있을까.
    
    JMM은 프로세서 타입별로 상이한 메모리 액세스 일관성을 고려하여 명시적으로 약한 모델로 설계되었다. 따라서 멀티스레드 코드가 제대로 작동하게 하려면 rock과 volatile을 적확히 알고 사용해야한다.
    

---

##  운영체제

OS의 주 임무는 여러 실행 프로세스가 공유하는 리소스 액세스를 관장한다. 한정된 리소스 가운데서도 메모리와 CPU 시간을 가장 중요한 리소스라고  할 수 있다. 

- 스케줄러
    
    프로세스 스케줄러는 CPU 엑세스를 통제한다. 이때 실행 큐를 이용한다.
    

- 컨텍스트 교환
    
    컨텍스트 교환은 OS 스케줄러가 현재 실행 중인 스레드/태스크를 없애고 대기 중인 다른 작업을 대체하는 프로세스이다. 유저 스레드 사이에 발생하든, 유저와 커널모드 사이에 발생하든 컨텍스트 교환은 비싼 작업이다.
    

---

##  기본 감지 전략

애플리케이션이 잘 돌아간다는 것은 CPU 사용량, 메모리, 네트워크, IO 대역폭 등 시스템 리소스를 효율적으로 잘 이용하고 있다는 뜻이다. 

성능 진단을 앞서 부족한 리소스가 뭔지 파악해야하지만 그렇다고 OS  자체가 시스템을 지치게 하는 원흉이 되어서도 안된다.

- CPU 사용률
- 가비자 수집
- 입출력
- 기계  공감
