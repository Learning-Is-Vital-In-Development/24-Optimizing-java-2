# 5. 마이크로벤치마킹과 통계

자바 성능 수치를 직접 측정하는 내용을 다룬다.

## 5.1 자바 성능 측정 기초

벤치마크를 하나의 과학실험처럼 바라보면 좋은 벤치마크를 작성하는데 도움이 된다.

벤치마크는, 입출력을 지닌 일종의 블랙 박스와도 같다.

어떤 결과를 추측/추론 하는데 필요한 데이터를 수집하려 하지만, 데이터를 모으는 것으로 충분하지 않고 그 데이터에 현혹되지 않도록 주의해야 한다.

자바 플랫폼을 벤치마크 할 때에는 자바 런타임의 정교함이 가장 문제이다.

최적화가 미치는 영향을 완전히 이해하고 설명하기는 불가능하다.

자바 코드 실행은 JIT 컴파일러, 메모리 관리, 그 밖의 자바 런타임이 제공하는 서브 시스템들과 완전히 떼어놓고 생각할 수 없다.

> 작업당 소요시간을 측정하는 벤치마크

이것의 문제점은 JVM의 웜업을 전혀 고려하지 않은 채로, 코드를 테스트했다.

이런방식으로 실행하게되면 몇시간, 며칠씩 걸릴 수 있지만, JIT 컴파일러가 JVM에 내장된 덕분에 바이트코드는 고도로 최적화한 기계어로 변환된다.

이 테스트만으로 운영계에서 어떻게 작동할지 모른다.

- Xms, Xmx
  - 힙 크기 조절 옵션
- PrintCompilation
  - 메소드를 컴파일할 때마다 로깅

JIT 컴파일러는 코드를 조금이라도 더 효율적으로 동작할 수 있게 호출 계층을 최적화한다.

벤치마크 성능은 캡처 타이밍에 따라 달라진다. 그렇기 때문에 JVM이 가동준비 마칠 수 있게 웜업단계를 거치는게 좋다.

### 가비지 컬렉션

GC가 일어나는 타이밍에 캡처하지 않는 것이 그나마 최선의 선택.

타이밍뿐 아니라 이터레이션 횟수도 정해야 하는데, 이 값을 찾기 어려울 때가 있다.

이 때 `--verbose.gc` 를 실행옵션으로 넣어주면 gc 동작을 볼 수 있다.

한번 측정한 결과로는 벤치마크가 어찌 수행됐는지 전체 사정을 속속들이 알 수 없다.

이 때, 허용오차를 구해 신뢰도를 파악하는게 좋다.

## 벤치마크 결과를 제대로 받아보기위한 2가지 해결 방안

### 시스템 전체를 벤치마크한다.

저수준의 수치는 무시하거나 수집하지 않는다.

수 많은 개별 작용의 전체 결과는 평균을 내어 더 큰 규모에서 유의미한 결과를 얻는다.

### 공통 프레임워크를 이용한다.

새로운 최적화 및 다른 외부 제어 변수가 잘 관리되도록 OpenJDK의 개발 흐름을 잘 따라가야 한다.

# 5.2 JMH 소개

## 5.2.1 될 수 있으면 마이크로 벤치마크하지 말자

## 5.2.2 휴리스틱: 마이크로벤치마킹은 언제 하나?

### 저수준 분석, 마이크로벤치마킹의 주요 유즈케이스

- 사용 범위가 넓은 범용 라이브러리 코드 개발
  - 사용되는 컨텍스트의 정보가 제한적
  - 아주 폭넓은 유즈케이스에 걸쳐 쓸만한 더 나은 성능을 보여야함.
- OpenJDK 또는 다른 자바 플랫폼 구현체 개발
- 지연에 극도로 민감한 코드를 개발

일반적으로 마이크로벤치마크는 가장 극단적 애플리케이션에 한해 사용하는게 좋다.

- 총 코드 경로 실행 시간 적어도 1밀리초, 실제 100마이크로초 보다 짧아야 한다.
- 메모리 할당률을 측정하는데, 그 값이 1MB/s 미만, 0에 가까운 값이어야 한다.
- 100% 가까운 CPU사용량을 가지고, 이용률은 10% 밑으로 유지한다.
- 실행 프로파일러로 CPU를 소비하는 메소드들의 분포를 이해해야 한다.

## 5.2.3 JMH 프레임워크

JMH는 자바를 비롯한 JVM 타깃하는 언어로 작성된 벤치마크를 제작, 실행, 분석하는 자바 도구

JVM을 빌드한 사람들이 직접 만든 프레임워크이기에 JMH 제작자는 JVM 버전별로 숨겨진 함정과 베어트랩을 어떻게 피하는지 잘 안다.

JMH는 벤치마크 툴에 관한 몇가지 핵심적인 설계 이슈를 고려했다.

벤치마크 프레임워크는 컴파일 타임에 벤치마크 내용을 알 수 없으므로 동적이어야 한다.

## 5.2.4 벤치마크 실행

[JMH 공식 깃허브](https://github.com/melix/jmh-gradle-plugin)

`@BenchMark` 를 메소드에 붙여 사용한다. JMH프레임워크는 상태를 제어하는 기능까지 제공한다.

# 5.3 JVM 성능 통계

모든 측정은 어느정도의 오차를 수반한다.

## 5.3.1 오차 유형

### 랜덤오차

측정 오차 또는 무관계 요인이 어떤 상관관계 없이 결과에 영향을 미침.

대부분 정규분포를 따른다.

### 계통오차

원인을 알 수 없는 요인이 상관관계 있는 형태로 측정에 영향을 미침.

`정확도`는 계통 오차의 수준을 나타내는 용어, 정확도가 높으면 계통 오차가 낮은 것이다.

`정밀도`는 랜덤 오차를 나타내는 용어로서, 정밀도가 높으면 랜덤오차가 낮은 것이다.

# 정리

마이크로벤치마킹은 뭔가 대단하지만 실상은 꼭 그렇지 않다.

- 유즈케이스를 모르는 상태에서 하지말자.
- 그래도 벤치마킹을 해야한다면 JMH
- 우리가 얻은 결과를 많은 사람과 공유하고 논의하자
- 항상 잘못될 가능성을 염두에 두고 지속적으로 검증하자.
